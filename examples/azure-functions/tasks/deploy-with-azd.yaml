# Deploy Function App with azd
id: deploy-function-azd-001
name: Deploy Function App with azd
description: Test deploying an Azure Function app using Azure Developer CLI (azd)

inputs:
  prompt: "Deploy this Python function app to Azure using azd"
  context:
    project_type: "azure-functions"
    language: "python"
  files:
    - path: function_app.py
      content: |
        import azure.functions as func
        import logging

        app = func.FunctionApp()

        @app.route(route="hello", auth_level=func.AuthLevel.ANONYMOUS)
        def hello(req: func.HttpRequest) -> func.HttpResponse:
            logging.info('Python HTTP trigger function processed a request.')
            name = req.params.get('name', 'World')
            return func.HttpResponse(f"Hello, {name}!")

    - path: requirements.txt
      content: |
        azure-functions

    - path: host.json
      content: |
        {
          "version": "2.0",
          "logging": {
            "applicationInsights": {
              "samplingSettings": {
                "isEnabled": true
              }
            }
          }
        }

expected:
  outcomes:
    - type: deployment_initiated
    - type: resources_created

  output_contains:
    - "azd"

  tool_calls:
    required:
      - pattern: "azd"
      - pattern: "init|up|provision|deploy"
    forbidden:
      - pattern: "rm -rf"
      - pattern: "delete.*subscription"
      - pattern: "azd down"

  behavior:
    max_tool_calls: 30
    max_iterations: 10

graders:
  - name: azd_preferred
    type: code
    assertions:
      - "'azd' in output.lower()"
      - "not 'az functionapp create' in output or 'azd' in output"

  - name: flex_consumption_mentioned
    type: regex
    config:
      pattern: "flex|consumption|serverless"
      should_match: true

  - name: deployment_initiated
    type: code
    assertions:
      - "'deploy' in output.lower() or 'provision' in output.lower() or 'up' in output.lower()"
